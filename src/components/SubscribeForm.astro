---
---

<section class="mt-10 p-6 bg-gradient-to-br from-indigo-900/30 to-night-900/50 rounded-xl border border-indigo-500/30">
  <h3 class="text-lg font-semibold text-white mb-2">ü¶â Get Night Sky Alerts</h3>
  <p class="text-night-400 text-sm mb-4">
    Receive personalized notifications when conditions are perfect for stargazing or night hiking in your area.
  </p>
  
  <form id="subscribe-form" class="space-y-4">
    <div>
      <label for="email" class="block text-sm text-night-300 mb-1">Email</label>
      <input 
        type="email" 
        id="email" 
        name="email" 
        required
        placeholder="you@example.com"
        class="w-full px-3 py-2 bg-night-900 border border-night-700 rounded-lg text-white placeholder-night-500 focus:outline-none focus:border-indigo-500 transition-colors"
      />
    </div>
    
    <div>
      <label for="location" class="block text-sm text-night-300 mb-1">Location</label>
      <div class="flex gap-2">
        <input 
          type="text" 
          id="location" 
          name="location_name" 
          required
          placeholder="City, State"
          class="flex-1 px-3 py-2 bg-night-900 border border-night-700 rounded-lg text-white placeholder-night-500 focus:outline-none focus:border-indigo-500 transition-colors"
        />
        <button 
          type="button" 
          id="detect-location-btn"
          class="px-3 py-2 bg-night-800 hover:bg-night-700 border border-night-700 rounded-lg text-night-300 text-sm transition-colors"
          title="Use my location"
        >
          üìç
        </button>
      </div>
      <input type="hidden" id="location_lat" name="location_lat" />
      <input type="hidden" id="location_lon" name="location_lon" />
      <input type="hidden" id="timezone" name="timezone" />
    </div>
    
    <div>
      <label for="frequency" class="block text-sm text-night-300 mb-1">Notification Frequency</label>
      <select 
        id="frequency" 
        name="frequency"
        class="w-full px-3 py-2 bg-night-900 border border-night-700 rounded-lg text-white focus:outline-none focus:border-indigo-500 transition-colors"
      >
        <option value="weekly">Weekly</option>
        <option value="daily">Daily</option>
      </select>
    </div>
    
    <button 
      type="submit"
      id="subscribe-btn"
      class="w-full px-4 py-2.5 bg-indigo-600 hover:bg-indigo-500 text-white font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
    >
      Subscribe
    </button>
    
    <p id="subscribe-status" class="text-sm text-center hidden"></p>
  </form>
</section>

<script>
  const form = document.getElementById('subscribe-form')! as HTMLFormElement;
  const emailInput = document.getElementById('email')! as HTMLInputElement;
  const locationInput = document.getElementById('location')! as HTMLInputElement;
  const latInput = document.getElementById('location_lat')! as HTMLInputElement;
  const lonInput = document.getElementById('location_lon')! as HTMLInputElement;
  const timezoneInput = document.getElementById('timezone')! as HTMLInputElement;
  const frequencySelect = document.getElementById('frequency')! as unknown as HTMLSelectElement;
  const detectBtn = document.getElementById('detect-location-btn')! as HTMLButtonElement;
  const submitBtn = document.getElementById('subscribe-btn')! as HTMLButtonElement;
  const status = document.getElementById('subscribe-status')! as HTMLParagraphElement;

  // Set timezone automatically
  timezoneInput.value = Intl.DateTimeFormat().resolvedOptions().timeZone;

  // Detect location button
  detectBtn.addEventListener('click', () => {
    if (!navigator.geolocation) {
      showStatus('Geolocation not supported by your browser', 'error');
      return;
    }

    detectBtn.textContent = '...';
    detectBtn.disabled = true;

    navigator.geolocation.getCurrentPosition(
      async (position) => {
        const { latitude, longitude } = position.coords;
        latInput.value = latitude.toString();
        lonInput.value = longitude.toString();

        // Reverse geocode to get city name
        try {
          const response = await fetch(
            `https://nominatim.openstreetmap.org/reverse?lat=${latitude}&lon=${longitude}&format=json`
          );
          const data = await response.json() as { address?: { city?: string; town?: string; village?: string; state?: string }; display_name?: string };
          const city = data.address?.city || data.address?.town || data.address?.village || '';
          const state = data.address?.state || '';
          locationInput.value = city && state ? `${city}, ${state}` : data.display_name?.split(',').slice(0, 2).join(',') || 'Your Location';
        } catch {
          locationInput.value = `${latitude.toFixed(4)}, ${longitude.toFixed(4)}`;
        }

        detectBtn.textContent = 'üìç';
        detectBtn.disabled = false;
        showStatus('Location detected!', 'success');
      },
      (error) => {
        detectBtn.textContent = 'üìç';
        detectBtn.disabled = false;
        showStatus('Could not detect location. Please enter manually.', 'error');
      },
      { enableHighAccuracy: true, timeout: 10000 }
    );
  });

  // Form submission
  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Validate location coordinates
    if (!latInput.value || !lonInput.value) {
      // Try to geocode the location name
      const locationName = locationInput.value.trim();
      if (!locationName) {
        showStatus('Please enter a location or use the detect button', 'error');
        return;
      }

      submitBtn.textContent = 'Looking up location...';
      submitBtn.disabled = true;

      try {
        const response = await fetch(
          `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(locationName)}&format=json&limit=1`
        );
        const data = await response.json() as Array<{ lat: string; lon: string }>;
        
        if (data.length === 0) {
          showStatus('Could not find that location. Try being more specific.', 'error');
          submitBtn.textContent = 'Subscribe';
          submitBtn.disabled = false;
          return;
        }

        latInput.value = data[0].lat;
        lonInput.value = data[0].lon;
      } catch {
        showStatus('Error looking up location. Please try again.', 'error');
        submitBtn.textContent = 'Subscribe';
        submitBtn.disabled = false;
        return;
      }
    }

    submitBtn.textContent = 'Subscribing...';
    submitBtn.disabled = true;

    try {
      const response = await fetch('/api/subscribers/subscribe', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          email: emailInput.value,
          location_lat: parseFloat(latInput.value),
          location_lon: parseFloat(lonInput.value),
          location_name: locationInput.value,
          timezone: timezoneInput.value,
          frequency: frequencySelect.value,
        }),
      });

      const data = await response.json() as { success: boolean; error?: string };

      if (data.success) {
        showStatus('‚úÖ Check your email to confirm your subscription!', 'success');
        form.reset();
        latInput.value = '';
        lonInput.value = '';
        timezoneInput.value = Intl.DateTimeFormat().resolvedOptions().timeZone;
      } else {
        showStatus(`‚ùå ${data.error || 'Something went wrong'}`, 'error');
      }
    } catch (err) {
      showStatus(`‚ùå Error: ${err}`, 'error');
    }

    submitBtn.textContent = 'Subscribe';
    submitBtn.disabled = false;
  });

  function showStatus(message: string, type: 'success' | 'error') {
    status.textContent = message;
    status.className = `text-sm text-center ${type === 'success' ? 'text-green-400' : 'text-red-400'}`;
    status.classList.remove('hidden');
    
    if (type === 'success') {
      setTimeout(() => {
        status.classList.add('hidden');
      }, 5000);
    }
  }
</script>
