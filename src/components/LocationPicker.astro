---
interface Props {
  currentName: string;
  currentLat: number;
  currentLon: number;
  currentTimezone: string;
}

const { currentName, currentLat, currentLon, currentTimezone } = Astro.props;
---

<button 
  id="change-location-btn"
  class="group flex items-center gap-2 px-4 py-2 bg-night-900/60 hover:bg-night-800 border border-night-700 hover:border-night-600 rounded-full transition-all"
  title="Change location"
>
  <span id="location-display" class="text-white font-medium">{currentName}</span>
  <svg class="w-4 h-4 text-night-500 group-hover:text-night-300 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
  </svg>
</button>

<!-- Loading Overlay -->
<div id="loading-overlay" class="fixed inset-0 bg-night-950/90 z-[60] hidden items-center justify-center">
  <div class="text-center">
    <div class="inline-block w-8 h-8 border-2 border-indigo-500 border-t-transparent rounded-full animate-spin mb-3"></div>
    <p id="loading-text" class="text-white font-medium">Loading forecast...</p>
  </div>
</div>

<!-- Location Modal -->
<div id="location-modal" class="fixed inset-0 bg-black/70 z-50 hidden items-center justify-center p-4">
  <div class="bg-night-900 rounded-xl border border-night-700 max-w-md w-full p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-semibold text-white">Change Location</h3>
      <button id="close-modal-btn" class="text-night-400 hover:text-white text-xl">&times;</button>
    </div>
    
    <div class="space-y-4">
      <button 
        id="use-my-location-btn"
        class="w-full px-4 py-3 bg-indigo-600 hover:bg-indigo-500 disabled:bg-indigo-800 disabled:cursor-wait text-white rounded-lg transition-colors flex items-center justify-center gap-2"
      >
        <span id="gps-icon">üìç</span> 
        <span id="gps-text">Use my exact location</span>
      </button>
      <p id="gps-error" class="text-red-400 text-xs text-center hidden"></p>
      
      <div class="relative">
        <div class="absolute inset-0 flex items-center">
          <div class="w-full border-t border-night-700"></div>
        </div>
        <div class="relative flex justify-center text-sm">
          <span class="px-2 bg-night-900 text-night-500">or search</span>
        </div>
      </div>
      
      <div class="relative">
        <input 
          type="text" 
          id="location-search"
          placeholder="Enter city name..."
          class="w-full px-3 py-2 bg-night-800 border border-night-700 rounded-lg text-white placeholder-night-500 focus:outline-none focus:border-indigo-500 transition-colors"
        />
        <div id="search-spinner" class="absolute right-3 top-1/2 -translate-y-1/2 hidden">
          <div class="w-4 h-4 border-2 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
        </div>
      </div>
      <div id="search-results" class="hidden max-h-48 overflow-y-auto">
        <!-- Results will be populated here -->
      </div>
      
      <p id="location-status" class="text-sm text-center hidden"></p>
    </div>
  </div>
</div>

<script define:vars={{ currentLat, currentLon, currentTimezone, currentName }}>
  // Store current location in localStorage for persistence
  const STORAGE_KEY = 'owltrek_location';
  
  // Initialize from localStorage or use server-provided values
  let location = JSON.parse(localStorage.getItem(STORAGE_KEY) || 'null') || {
    lat: currentLat,
    lon: currentLon,
    timezone: currentTimezone,
    name: currentName
  };

  // DOM elements
  const modal = document.getElementById('location-modal');
  const loadingOverlay = document.getElementById('loading-overlay');
  const loadingText = document.getElementById('loading-text');
  const changeBtn = document.getElementById('change-location-btn');
  const closeBtn = document.getElementById('close-modal-btn');
  const useMyLocationBtn = document.getElementById('use-my-location-btn');
  const gpsIcon = document.getElementById('gps-icon');
  const gpsText = document.getElementById('gps-text');
  const gpsError = document.getElementById('gps-error');
  const searchInput = document.getElementById('location-search');
  const searchSpinner = document.getElementById('search-spinner');
  const searchResults = document.getElementById('search-results');
  const locationDisplay = document.getElementById('location-display');
  const statusEl = document.getElementById('location-status');

  // Update display if we have a stored location different from server
  if (localStorage.getItem(STORAGE_KEY)) {
    locationDisplay.textContent = location.name;
    // If stored location differs from server location, reload with new data
    if (location.lat !== currentLat || location.lon !== currentLon) {
      const params = new URLSearchParams(window.location.search);
      if (!params.has('lat')) {
        showLoading('Loading your saved location...');
        window.location.href = `/?lat=${location.lat}&lon=${location.lon}&tz=${encodeURIComponent(location.timezone)}&name=${encodeURIComponent(location.name)}`;
      }
    }
  }

  // Show/hide loading overlay
  function showLoading(text = 'Loading forecast...') {
    loadingText.textContent = text;
    loadingOverlay?.classList.remove('hidden');
    loadingOverlay?.classList.add('flex');
  }

  changeBtn?.addEventListener('click', () => {
    modal?.classList.remove('hidden');
    modal?.classList.add('flex');
    gpsError?.classList.add('hidden');
  });

  closeBtn?.addEventListener('click', closeModal);
  modal?.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
  });

  function closeModal() {
    modal?.classList.add('hidden');
    modal?.classList.remove('flex');
  }

  function showGpsError(message) {
    gpsError.textContent = message;
    gpsError?.classList.remove('hidden');
  }

  function setLocation(lat, lon, timezone, name) {
    location = { lat, lon, timezone, name };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(location));
    closeModal();
    showLoading(`Loading forecast for ${name}...`);
    window.location.href = `/?lat=${lat}&lon=${lon}&tz=${encodeURIComponent(timezone)}&name=${encodeURIComponent(name)}`;
  }

  // Use browser geolocation
  useMyLocationBtn?.addEventListener('click', () => {
    if (!navigator.geolocation) {
      showGpsError('Geolocation is not supported by your browser');
      return;
    }

    // Check if we're on HTTPS (required for geolocation)
    if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
      showGpsError('Location detection requires a secure connection (HTTPS)');
      return;
    }

    useMyLocationBtn.disabled = true;
    gpsIcon.innerHTML = '<span class="inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></span>';
    gpsText.textContent = 'Detecting location...';
    gpsError?.classList.add('hidden');

    navigator.geolocation.getCurrentPosition(
      async (position) => {
        gpsText.textContent = 'Getting city name...';
        const { latitude, longitude } = position.coords;
        const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;

        // Reverse geocode
        try {
          const response = await fetch(
            `https://nominatim.openstreetmap.org/reverse?lat=${latitude}&lon=${longitude}&format=json`
          );
          const data = await response.json();
          const city = data.address?.city || data.address?.town || data.address?.village || '';
          const state = data.address?.state || '';
          const name = city && state ? `${city}, ${state}` : city || `${latitude.toFixed(2)}, ${longitude.toFixed(2)}`;
          
          setLocation(latitude, longitude, timezone, name);
        } catch {
          setLocation(latitude, longitude, timezone, `${latitude.toFixed(2)}, ${longitude.toFixed(2)}`);
        }
      },
      (error) => {
        useMyLocationBtn.disabled = false;
        gpsIcon.textContent = 'üìç';
        gpsText.textContent = 'Use my exact location';
        
        // Provide specific error messages
        switch(error.code) {
          case error.PERMISSION_DENIED:
            showGpsError('Location access denied. Please enable location in your browser settings.');
            break;
          case error.POSITION_UNAVAILABLE:
            showGpsError('Location unavailable. Try searching for your city instead.');
            break;
          case error.TIMEOUT:
            showGpsError('Location request timed out. Please try again.');
            break;
          default:
            showGpsError('Could not detect location. Try searching for your city instead.');
        }
      },
      { enableHighAccuracy: false, timeout: 15000, maximumAge: 300000 }
    );
  });

  // Search functionality
  let searchTimeout;
  searchInput?.addEventListener('input', (e) => {
    clearTimeout(searchTimeout);
    const query = e.target.value.trim();
    
    if (query.length < 2) {
      searchResults?.classList.add('hidden');
      searchSpinner?.classList.add('hidden');
      return;
    }

    // Show spinner immediately
    searchSpinner?.classList.remove('hidden');

    searchTimeout = setTimeout(async () => {
      try {
        const response = await fetch(
          `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=5&addressdetails=1`
        );
        const results = await response.json();
        
        searchSpinner?.classList.add('hidden');
        
        if (results.length === 0) {
          searchResults.innerHTML = '<p class="text-night-500 text-sm p-2">No results found</p>';
        } else {
          searchResults.innerHTML = results.map(r => {
            const parts = r.display_name.split(',');
            const shortName = parts.slice(0, 2).join(',').trim();
            const fullName = parts.slice(0, 3).join(',').trim();
            return `
              <button 
                class="w-full text-left px-3 py-2 hover:bg-night-800 rounded text-sm text-white transition-colors flex items-center gap-2"
                data-lat="${r.lat}"
                data-lon="${r.lon}"
                data-name="${shortName}"
              >
                <span class="text-night-500">üìç</span>
                <span>${fullName}</span>
              </button>
            `;
          }).join('');
          
          // Add click handlers to results
          searchResults.querySelectorAll('button').forEach(btn => {
            btn.addEventListener('click', async () => {
              const lat = parseFloat(btn.dataset.lat);
              const lon = parseFloat(btn.dataset.lon);
              const name = btn.dataset.name;
              
              // Show loading state on the button
              btn.innerHTML = '<span class="inline-block w-4 h-4 border-2 border-indigo-500 border-t-transparent rounded-full animate-spin"></span> <span>Loading timezone...</span>';
              btn.disabled = true;
              
              // Look up timezone for the location
              let timezone = Intl.DateTimeFormat().resolvedOptions().timeZone; // fallback
              try {
                const tzResponse = await fetch(
                  `https://timeapi.io/api/timezone/coordinate?latitude=${lat}&longitude=${lon}`
                );
                if (tzResponse.ok) {
                  const tzData = await tzResponse.json();
                  timezone = tzData.timeZone || timezone;
                }
              } catch {
                // Use fallback timezone
              }
              
              setLocation(lat, lon, timezone, name);
            });
          });
        }
        
        searchResults?.classList.remove('hidden');
      } catch {
        searchSpinner?.classList.add('hidden');
        searchResults.innerHTML = '<p class="text-red-400 text-sm p-2">Search failed. Please try again.</p>';
        searchResults?.classList.remove('hidden');
      }
    }, 400);
  });
</script>
