---
interface Props {
  currentName: string;
  currentLat: number;
  currentLon: number;
  currentTimezone: string;
}

const { currentName, currentLat, currentLon, currentTimezone } = Astro.props;
---

<button 
  id="change-location-btn"
  class="group flex items-center gap-2 px-4 py-2 bg-night-900/60 hover:bg-night-800 border border-night-700 hover:border-night-600 rounded-full transition-all"
  title="Change location"
>
  <span id="location-display" class="text-white font-medium">{currentName}</span>
  <svg class="w-4 h-4 text-night-500 group-hover:text-night-300 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
  </svg>
</button>

<!-- Location Modal -->
<div id="location-modal" class="fixed inset-0 bg-black/70 z-50 hidden items-center justify-center p-4">
  <div class="bg-night-900 rounded-xl border border-night-700 max-w-md w-full p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-semibold text-white">Change Location</h3>
      <button id="close-modal-btn" class="text-night-400 hover:text-white text-xl">&times;</button>
    </div>
    
    <div class="space-y-4">
      <button 
        id="use-my-location-btn"
        class="w-full px-4 py-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg transition-colors flex items-center justify-center gap-2"
      >
        <span>üìç</span> Use my exact location
      </button>
      
      <div class="relative">
        <div class="absolute inset-0 flex items-center">
          <div class="w-full border-t border-night-700"></div>
        </div>
        <div class="relative flex justify-center text-sm">
          <span class="px-2 bg-night-900 text-night-500">or search</span>
        </div>
      </div>
      
      <div>
        <input 
          type="text" 
          id="location-search"
          placeholder="Enter city name..."
          class="w-full px-3 py-2 bg-night-800 border border-night-700 rounded-lg text-white placeholder-night-500 focus:outline-none focus:border-indigo-500 transition-colors"
        />
        <div id="search-results" class="mt-2 hidden">
          <!-- Results will be populated here -->
        </div>
      </div>
      
      <p id="location-status" class="text-sm text-center hidden"></p>
    </div>
  </div>
</div>

<script define:vars={{ currentLat, currentLon, currentTimezone, currentName }}>
  // Store current location in localStorage for persistence
  const STORAGE_KEY = 'owltrek_location';
  
  // Initialize from localStorage or use server-provided values
  let location = JSON.parse(localStorage.getItem(STORAGE_KEY) || 'null') || {
    lat: currentLat,
    lon: currentLon,
    timezone: currentTimezone,
    name: currentName
  };

  const modal = document.getElementById('location-modal');
  const changeBtn = document.getElementById('change-location-btn');
  const closeBtn = document.getElementById('close-modal-btn');
  const useMyLocationBtn = document.getElementById('use-my-location-btn');
  const searchInput = document.getElementById('location-search');
  const searchResults = document.getElementById('search-results');
  const locationDisplay = document.getElementById('location-display');
  const statusEl = document.getElementById('location-status');

  // Update display if we have a stored location different from server
  if (localStorage.getItem(STORAGE_KEY)) {
    locationDisplay.textContent = `üìç ${location.name}`;
    // If stored location differs from server location, reload with new data
    if (location.lat !== currentLat || location.lon !== currentLon) {
      // We'll handle this by reloading with query params
      const params = new URLSearchParams(window.location.search);
      if (!params.has('lat')) {
        // Redirect to use stored location
        window.location.href = `/?lat=${location.lat}&lon=${location.lon}&tz=${encodeURIComponent(location.timezone)}&name=${encodeURIComponent(location.name)}`;
      }
    }
  }

  changeBtn?.addEventListener('click', () => {
    modal?.classList.remove('hidden');
    modal?.classList.add('flex');
  });

  closeBtn?.addEventListener('click', closeModal);
  modal?.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
  });

  function closeModal() {
    modal?.classList.add('hidden');
    modal?.classList.remove('flex');
  }

  function showStatus(message, type) {
    statusEl.textContent = message;
    statusEl.className = `text-sm text-center ${type === 'success' ? 'text-green-400' : type === 'error' ? 'text-red-400' : 'text-night-400'}`;
    statusEl.classList.remove('hidden');
  }

  function setLocation(lat, lon, timezone, name) {
    location = { lat, lon, timezone, name };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(location));
    // Reload page with new location
    window.location.href = `/?lat=${lat}&lon=${lon}&tz=${encodeURIComponent(timezone)}&name=${encodeURIComponent(name)}`;
  }

  // Use browser geolocation
  useMyLocationBtn?.addEventListener('click', () => {
    if (!navigator.geolocation) {
      showStatus('Geolocation not supported', 'error');
      return;
    }

    useMyLocationBtn.disabled = true;
    useMyLocationBtn.innerHTML = '<span class="animate-pulse">Detecting...</span>';

    navigator.geolocation.getCurrentPosition(
      async (position) => {
        const { latitude, longitude } = position.coords;
        const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;

        // Reverse geocode
        try {
          const response = await fetch(
            `https://nominatim.openstreetmap.org/reverse?lat=${latitude}&lon=${longitude}&format=json`
          );
          const data = await response.json();
          const city = data.address?.city || data.address?.town || data.address?.village || '';
          const state = data.address?.state || '';
          const name = city && state ? `${city}, ${state}` : city || `${latitude.toFixed(2)}, ${longitude.toFixed(2)}`;
          
          setLocation(latitude, longitude, timezone, name);
        } catch {
          setLocation(latitude, longitude, timezone, `${latitude.toFixed(2)}, ${longitude.toFixed(2)}`);
        }
      },
      (error) => {
        useMyLocationBtn.disabled = false;
        useMyLocationBtn.innerHTML = '<span>üìç</span> Use my exact location';
        showStatus('Could not detect location', 'error');
      },
      { enableHighAccuracy: true, timeout: 10000 }
    );
  });

  // Search functionality
  let searchTimeout;
  searchInput?.addEventListener('input', (e) => {
    clearTimeout(searchTimeout);
    const query = e.target.value.trim();
    
    if (query.length < 2) {
      searchResults?.classList.add('hidden');
      return;
    }

    searchTimeout = setTimeout(async () => {
      try {
        const response = await fetch(
          `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=5`
        );
        const results = await response.json();
        
        if (results.length === 0) {
          searchResults.innerHTML = '<p class="text-night-500 text-sm">No results found</p>';
        } else {
          searchResults.innerHTML = results.map(r => `
            <button 
              class="w-full text-left px-3 py-2 hover:bg-night-800 rounded text-sm text-white transition-colors"
              data-lat="${r.lat}"
              data-lon="${r.lon}"
              data-name="${r.display_name.split(',').slice(0, 2).join(',')}"
            >
              ${r.display_name.split(',').slice(0, 3).join(',')}
            </button>
          `).join('');
          
          // Add click handlers to results
          searchResults.querySelectorAll('button').forEach(btn => {
            btn.addEventListener('click', () => {
              const lat = parseFloat(btn.dataset.lat);
              const lon = parseFloat(btn.dataset.lon);
              const name = btn.dataset.name;
              const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
              setLocation(lat, lon, timezone, name);
            });
          });
        }
        
        searchResults?.classList.remove('hidden');
      } catch {
        searchResults.innerHTML = '<p class="text-red-400 text-sm">Search failed</p>';
        searchResults?.classList.remove('hidden');
      }
    }, 300);
  });
</script>
