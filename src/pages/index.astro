---
import { getNextWeek, formatTimeInTimezone, formatDateInTimezone } from '../lib/dates';
import { analyzeNight, getMoonPhaseName, type NightAnalysis } from '../lib/analyzer';
import { getWeatherForecast } from '../lib/weather';
import SubscribeForm from '../components/SubscribeForm.astro';
import LocationPicker from '../components/LocationPicker.astro';
import HeroCard from '../components/HeroCard.astro';
import MoonCalendar from '../components/MoonCalendar.astro';

// Get location from Cloudflare's cf object, with fallback
const cf = Astro.locals.runtime?.cf;

// Check for query params (user-selected location)
const url = new URL(Astro.request.url);
const queryLat = url.searchParams.get('lat');
const queryLon = url.searchParams.get('lon');
const queryTz = url.searchParams.get('tz');
const queryName = url.searchParams.get('name');

// Default fallback location (San Diego, CA)
const DEFAULT_LOCATION = {
  lat: 32.7157,
  lon: -117.1611,
  timezone: 'America/Los_Angeles',
  name: 'San Diego, CA'
};

// Priority: Query params > Cloudflare geolocation > Default
const LOCATION = queryLat && queryLon ? {
  lat: parseFloat(queryLat),
  lon: parseFloat(queryLon),
  timezone: queryTz || DEFAULT_LOCATION.timezone,
  name: queryName || 'Custom Location'
} : {
  lat: cf?.latitude ? parseFloat(cf.latitude as string) : DEFAULT_LOCATION.lat,
  lon: cf?.longitude ? parseFloat(cf.longitude as string) : DEFAULT_LOCATION.lon,
  timezone: (cf?.timezone as string) || DEFAULT_LOCATION.timezone,
  name: cf?.city && cf?.region 
    ? `${cf.city}, ${cf.region}` 
    : cf?.city 
      ? String(cf.city)
      : DEFAULT_LOCATION.name
};

// Get next 7 days in the target timezone (limited by weather forecast accuracy)
const dates = getNextWeek(LOCATION.timezone);

// Fetch weather data
let weatherData = new Map();
try {
  weatherData = await getWeatherForecast(LOCATION.lat, LOCATION.lon);
} catch (e) {
  console.error('Weather fetch failed:', e);
}

// Analyze each night, passing weather data when available
const analyses: NightAnalysis[] = dates.map(date => {
  const dateStr = date.toISOString().split('T')[0];
  const weather = weatherData.get(dateStr);
  return analyzeNight(date, LOCATION.lat, LOCATION.lon, LOCATION.timezone, weather);
});

// Find the next good night for the hero card
const nextGoodNight = analyses
  .map((a, i) => ({ analysis: a, date: dates[i], daysFromNow: i }))
  .find(x => x.analysis.isGoodNight) || null;
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Find the best nights for hiking and stargazing" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <title>OwlTrek</title>
</head>
<body class="min-h-screen bg-night-950 text-white">
  <div class="container mx-auto px-4 py-8 max-w-4xl">
    
    <!-- Header -->
    <header class="text-center mb-8">
      <h1 class="text-3xl font-bold mb-3">ü¶â OwlTrek</h1>
      <p class="text-night-500 text-sm mb-3">Night sky forecast for</p>
      <LocationPicker 
        currentName={LOCATION.name}
        currentLat={LOCATION.lat}
        currentLon={LOCATION.lon}
        currentTimezone={LOCATION.timezone}
      />
    </header>

    <!-- Hero Card: Next Good Night -->
    <HeroCard nextGoodNight={nextGoodNight} timezone={LOCATION.timezone} />

    <!-- Tab Navigation -->
    <div class="flex border-b border-night-800 mb-6">
      <button 
        id="tab-week" 
        class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-indigo-500 text-white"
        data-tab="week"
      >
        This Week
      </button>
      <button 
        id="tab-calendar" 
        class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-night-400 hover:text-night-200"
        data-tab="calendar"
      >
        Moon Calendar
      </button>
    </div>

    <!-- Tab Content: This Week -->
    <div id="content-week" class="tab-content">
    <!-- 7 Day Forecast -->
    <section class="mb-8">
      <h2 class="text-lg font-medium text-night-300 mb-4">7 Day Night Forecast</h2>
      <div class="space-y-2">
        {analyses.map((analysis, index) => {
          const isGood = analysis.isGoodNight;
          const isHiking = analysis.goodNightType === 'hiking';
          return (
            <details class={`group rounded-xl border-2 overflow-hidden transition-all ${
              isGood
                ? isHiking 
                  ? 'bg-amber-900/30 border-amber-500 shadow-lg shadow-amber-500/20' 
                  : 'bg-indigo-900/30 border-indigo-500 shadow-lg shadow-indigo-500/20'
                : 'bg-night-900/20 border-night-800 opacity-60'
            }`}>
              <summary class={`p-4 cursor-pointer list-none flex items-center justify-between transition-colors ${
                isGood ? 'hover:bg-white/10' : 'hover:bg-white/5'
              }`}>
                <div class="flex items-center gap-4">
                  {isGood ? (
                    <span class="text-3xl">{isHiking ? 'üåï' : '‚ú®'}</span>
                  ) : (
                    <span class="text-xl text-night-600">üåô</span>
                  )}
                  <div>
                    <p class={`font-semibold ${
                      isGood 
                        ? isHiking ? 'text-amber-100 text-lg' : 'text-indigo-100 text-lg'
                        : 'text-night-400'
                    }`}>
                      {index === 0 ? 'Tonight' : formatDateInTimezone(dates[index], LOCATION.timezone)}
                    </p>
                    {isGood ? (
                      <p class={`text-sm font-medium ${isHiking ? 'text-amber-400' : 'text-indigo-400'}`}>
                        {analysis.reason}
                      </p>
                    ) : (
                      <p class="text-sm text-night-500">
                        {getMoonPhaseName(analysis.moonPhase)} ‚Ä¢ {analysis.weather}
                      </p>
                    )}
                  </div>
                </div>
                <div class="flex items-center gap-3">
                  <div class="text-right text-sm text-night-400">
                    <p>{analysis.illumination}% moon</p>
                    {analysis.hasWeatherData && analysis.cloudCover !== null && (
                      <p>{analysis.cloudCover}% clouds</p>
                    )}
                  </div>
                  <span class="text-night-500 group-open:rotate-180 transition-transform">‚ñº</span>
                </div>
              </summary>
              <div class="px-4 pb-4 pt-2 border-t border-white/10">
                <div class="grid grid-cols-2 gap-x-6 gap-y-2 text-sm">
                  <div class="flex justify-between">
                    <span class="text-night-400">Sunset</span>
                    <span class="text-white">{formatTimeInTimezone(analysis.sunset, LOCATION.timezone)}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-night-400">Moon Phase</span>
                    <span class="text-white">{getMoonPhaseName(analysis.moonPhase)}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-night-400">Moon Rise</span>
                    <span class="text-white">{formatTimeInTimezone(analysis.moonRise, LOCATION.timezone)}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-night-400">Illumination</span>
                    <span class="text-white">{analysis.illumination}%</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-night-400">Moon Set</span>
                    <span class="text-white">{formatTimeInTimezone(analysis.moonSet, LOCATION.timezone)}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-night-400">Weather</span>
                    <span class="text-white">{analysis.weather}</span>
                  </div>
                  {analysis.hasWeatherData && (
                    <>
                      <div class="flex justify-between">
                        <span class="text-night-400">Cloud Cover</span>
                        <span class="text-white">{analysis.cloudCover}%</span>
                      </div>
                      <div class="flex justify-between">
                        <span class="text-night-400">Temperature</span>
                        <span class="text-white">{analysis.temperature}¬∞C</span>
                      </div>
                      <div class="flex justify-between">
                        <span class="text-night-400">Wind</span>
                        <span class="text-white">{analysis.windSpeed} km/h</span>
                      </div>
                    </>
                  )}
                </div>
              </div>
            </details>
          );
        })}
      </div>
    </section>
    </div>

    <!-- Tab Content: Moon Calendar -->
    <div id="content-calendar" class="tab-content hidden">
      <MoonCalendar lat={LOCATION.lat} lon={LOCATION.lon} timezone={LOCATION.timezone} />
    </div>

    <!-- Subscribe Form -->
    <SubscribeForm />
<!-- 
    <section class="mt-10 p-4 bg-night-900/50 rounded-lg border border-night-700">
      <h3 class="text-sm font-medium text-night-300 mb-2">üß™ Developer Test</h3>
      <button 
        id="test-email-btn"
        class="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white text-sm rounded transition-colors"
      >
        Send Test Email
      </button>
      <span id="email-status" class="ml-3 text-sm text-night-400"></span>
    </section>

    <script>
      const btn = document.getElementById('test-email-btn');
      const status = document.getElementById('email-status');
      
      btn?.addEventListener('click', async () => {
        btn.disabled = true;
        btn.textContent = 'Sending...';
        status!.textContent = '';
        
        try {
          const res = await fetch('/api/send-digest', { method: 'POST' });
          const data = await res.json();
          
          if (data.success) {
            status!.textContent = `‚úÖ Email sent! (${data.goodNightsCount} good nights)`;
            status!.className = 'ml-3 text-sm text-green-400';
          } else {
            status!.textContent = `‚ùå Failed: ${data.error?.message || 'Unknown error'}`;
            status!.className = 'ml-3 text-sm text-red-400';
          }
        } catch (err) {
          status!.textContent = `‚ùå Error: ${err}`;
          status!.className = 'ml-3 text-sm text-red-400';
        }
        
        btn.disabled = false;
        btn.textContent = 'Send Test Email';
      });
    </script> -->

    <!-- Footer -->
    <footer class="mt-10 text-center text-night-600 text-xs">
      <p>Times in {LOCATION.timezone} ‚Ä¢ Moon data via SunCalc</p>
    </footer>
  </div>

  <script>
    // Tab switching logic
    const tabBtns = document.querySelectorAll<HTMLButtonElement>('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');

    tabBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const tab = btn.dataset.tab;
        
        // Update button styles
        tabBtns.forEach(b => {
          b.classList.remove('border-indigo-500', 'text-white');
          b.classList.add('border-transparent', 'text-night-400');
        });
        btn.classList.remove('border-transparent', 'text-night-400');
        btn.classList.add('border-indigo-500', 'text-white');
        
        // Show/hide content
        tabContents.forEach(content => {
          content.classList.add('hidden');
        });
        document.getElementById(`content-${tab}`)?.classList.remove('hidden');
      });
    });
  </script>
</body>
</html>
