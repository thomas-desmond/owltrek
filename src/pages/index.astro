---
import { getNextTwoWeeks, formatTimeInTimezone, formatDateInTimezone } from '../lib/dates';
import { analyzeNight, getMoonPhaseName, type NightAnalysis } from '../lib/analyzer';
import SubscribeForm from '../components/SubscribeForm.astro';

// Location Configuration - San Diego, CA
const LOCATION = {
  lat: 32.7157,
  lon: -117.1611,
  timezone: 'America/Los_Angeles',
  name: 'San Diego, CA'
};

// Get next 14 days in the target timezone
const dates = getNextTwoWeeks(LOCATION.timezone);

// Analyze each night
const analyses: NightAnalysis[] = dates.map(date => 
  analyzeNight(date, LOCATION.lat, LOCATION.lon, LOCATION.timezone)
);

// Separate good nights from regular nights
const goodNightsList = analyses.map((a, i) => ({ analysis: a, index: i })).filter(x => x.analysis.isGoodNight);
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Find the best nights for hiking and stargazing" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <title>OwlTrek</title>
</head>
<body class="min-h-screen bg-night-950 text-white">
  <div class="container mx-auto px-4 py-8 max-w-4xl">
    
    <!-- Header -->
    <header class="text-center mb-10">
      <h1 class="text-3xl font-bold mb-1">ü¶â OwlTrek</h1>
      <p class="text-night-400 text-sm">üìç {LOCATION.name}</p>
    </header>

    <!-- Good Nights Section -->
    {goodNightsList.length > 0 ? (
      <section class="mb-12">
        <h2 class="text-lg font-medium text-night-300 mb-4">Go outside on these nights over the next 14 days</h2>
        <div class="space-y-3">
          {goodNightsList.map(({ analysis, index }) => (
            <details class={`group rounded-lg border overflow-hidden ${
              analysis.goodNightType === 'hiking' 
                ? 'bg-amber-900/20 border-amber-500/40' 
                : 'bg-indigo-900/20 border-indigo-500/40'
            }`}>
              <summary class="p-4 cursor-pointer list-none flex items-center justify-between hover:bg-white/5 transition-colors">
                <div>
                  <p class="font-semibold text-lg">
                    {index === 0 ? 'Tonight' : formatDateInTimezone(dates[index], LOCATION.timezone)}
                  </p>
                  <p class={`text-sm mt-0.5 ${
                    analysis.goodNightType === 'hiking' ? 'text-amber-400' : 'text-indigo-400'
                  }`}>
                    {analysis.goodNightType === 'hiking' ? 'üåï' : '‚ú®'} {analysis.reason}
                  </p>
                </div>
                <div class="flex items-center gap-3">
                  <div class="text-right text-sm text-night-400">
                    <p>{getMoonPhaseName(analysis.moonPhase)}</p>
                    <p>{analysis.illumination}% lit</p>
                  </div>
                  <span class="text-night-500 group-open:rotate-180 transition-transform">‚ñº</span>
                </div>
              </summary>
              <div class="px-4 pb-4 pt-2 border-t border-white/10">
                <div class="grid grid-cols-2 gap-x-6 gap-y-2 text-sm">
                  <div class="flex justify-between">
                    <span class="text-night-400">Sunset</span>
                    <span class="text-white">{formatTimeInTimezone(analysis.sunset, LOCATION.timezone)}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-night-400">Moon Phase</span>
                    <span class="text-white">{getMoonPhaseName(analysis.moonPhase)}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-night-400">Moon Rise</span>
                    <span class="text-white">{formatTimeInTimezone(analysis.moonRise, LOCATION.timezone)}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-night-400">Illumination</span>
                    <span class="text-white">{analysis.illumination}%</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-night-400">Moon Set</span>
                    <span class="text-white">{formatTimeInTimezone(analysis.moonSet, LOCATION.timezone)}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-night-400">Weather</span>
                    <span class="text-white">{analysis.weather}</span>
                  </div>
                </div>
              </div>
            </details>
          ))}
        </div>
      </section>
    ) : (
      <section class="mb-12 text-center py-8">
        <p class="text-night-400">No ideal nights in the next two weeks.</p>
        <p class="text-night-500 text-sm mt-1">Check back later for updates.</p>
      </section>
    )}

    <!-- All Nights Calendar -->
    <section>
      <h2 class="text-lg font-medium text-night-300 mb-4">Full 14 day forecast</h2>
      <div class="grid grid-cols-7 gap-1 text-center text-xs">
        {analyses.map((analysis, index) => {
          const isGood = analysis.isGoodNight;
          const isHiking = analysis.goodNightType === 'hiking';
          return (
            <div 
              class={`rounded p-2 ${
                isGood 
                  ? isHiking 
                    ? 'bg-amber-900/30 border border-amber-500/30' 
                    : 'bg-indigo-900/30 border border-indigo-500/30'
                  : 'bg-night-900/50'
              }`}
              title={`${analysis.dateString} - ${getMoonPhaseName(analysis.moonPhase)} (${analysis.illumination}%)`}
            >
              <p class={`font-medium ${index === 0 ? 'text-yellow-400' : isGood ? 'text-white' : 'text-night-400'}`}>
                {new Date(analysis.dateString).getDate()}
              </p>
              <p class="text-night-500 mt-0.5">{analysis.illumination}%</p>
              {isGood && (
                <p class="mt-0.5">{isHiking ? 'üåï' : '‚ú®'}</p>
              )}
            </div>
          );
        })}
      </div>
    </section>

    <!-- Subscribe Form -->
    <SubscribeForm />
<!-- 
    <section class="mt-10 p-4 bg-night-900/50 rounded-lg border border-night-700">
      <h3 class="text-sm font-medium text-night-300 mb-2">üß™ Developer Test</h3>
      <button 
        id="test-email-btn"
        class="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white text-sm rounded transition-colors"
      >
        Send Test Email
      </button>
      <span id="email-status" class="ml-3 text-sm text-night-400"></span>
    </section>

    <script>
      const btn = document.getElementById('test-email-btn');
      const status = document.getElementById('email-status');
      
      btn?.addEventListener('click', async () => {
        btn.disabled = true;
        btn.textContent = 'Sending...';
        status!.textContent = '';
        
        try {
          const res = await fetch('/api/send-digest', { method: 'POST' });
          const data = await res.json();
          
          if (data.success) {
            status!.textContent = `‚úÖ Email sent! (${data.goodNightsCount} good nights)`;
            status!.className = 'ml-3 text-sm text-green-400';
          } else {
            status!.textContent = `‚ùå Failed: ${data.error?.message || 'Unknown error'}`;
            status!.className = 'ml-3 text-sm text-red-400';
          }
        } catch (err) {
          status!.textContent = `‚ùå Error: ${err}`;
          status!.className = 'ml-3 text-sm text-red-400';
        }
        
        btn.disabled = false;
        btn.textContent = 'Send Test Email';
      });
    </script> -->

    <!-- Footer -->
    <footer class="mt-10 text-center text-night-600 text-xs">
      <p>Times in {LOCATION.timezone} ‚Ä¢ Moon data via SunCalc</p>
    </footer>
  </div>
</body>
</html>
